#!/bin/bash

function warn {
  # color:yellow
  echo -e "\033[33mWarning\033[m" "$*"
}

function error {
  # color:red
  echo -e "\033[31mError\033[m" "$*"
}

function success {
  # color:green
  echo -e "\033[32mSuccess\033[m" "$*"
}

function check_os {
  case ${OSTYPE} in
    linux*)
      success "OK"
      ;;
    *)
      error "$OSTYPE is NOT supported, exitting"
      exit 1
      ;;
  esac
}

function check_available {
  which "$1" &>/dev/null
  return $?
}

function install_zlib {
  cd ~/picnic-tmp
  wget http://zlib.net/zlib-1.2.8.tar.gz
  tar zxvf zlib-1.2.8.tar.gz
  cd zlib-1.2.8
  ./configure --prefix=$HOME/picnic-tools
  make &&
  make install &&
  success "installed zlib to $HOME/picnic-tools"
  export CPPFLAGS="-I$HOME/picnic-tools/include" LDFLAGS="-L$HOME/picnic-tools/lib"
}


function install_git {
  cd ~/picnic-tmp
  wget https://www.kernel.org/pub/software/scm/git/git-2.8.1.tar.gz
  tar zxvf git-2.8.1.tar.gz
  cd git-2.8.1
  ./configure --prefix=$HOME/picnic-tools --with-curl=$HOME/picnic-tools NO_OPENSSL=1 NO_CURL=1
  make &&
  make install &&
  success "installed git to $HOME/picnic-tools"
}

function install_curl {
  cd ~/picnic-tmp
  wget http://www.execve.net/curl/curl-7.48.0.tar.gz
  tar zxvf curl-7.48.0.tar.gz
  cd curl-7.48.0
  ./configure --with-ssl --prefix=$HOME/picnic-tools 
  make &&
  make install &&
  success "installed curl to $HOME/picnic-tools"
}

# SUBCOMMANDS

function picnic-unpack {
  check_os
  mkdir ~/picnic-tmp
  # case "$(check_available curl)" in
  #   0 )
  #     $CURLDIR="$(which curl)"
  #     ;;
  #   1 )
  #     $CURLDIR="$HOME/picnic-tools"
  #     install_curl
  #     ;;
  # esac
  install_curl
  install_zlib
  install_git
  # echo "PATH=$PATH:~/picnic/bin" >> "~/.$(basename $SHELL)rc"
}

function picnic-remove {
  if [ -e ~/picnic-tools ]; then
    rm -rf ~/picnic-*
  fi
}

function picnic-help {
  echo "picnic-0.1.0"
  echo "  unpack: install from source"
  echo "  remove: remove files"
}

# MAIN

SUBCOMMAND=""
ARGS=()
while [ $# -gt 0 ]
do
  case "$1" in

    --help|--version|-V)
      picnic-help
      exit 0
    ;;

    *)
      if [ -z "$SUBCOMMAND" ]; then
        SUBCOMMAND="$1"
      else
        ARGS+=( "$1" )
      fi
      shift
    ;;
  esac
done

function invoke_subcommand {
  local SUBCOMMAND="${@:1:1}"
  local ARGS=( "${@:2}" )
  local ACTION="picnic-${SUBCOMMAND:-help}"
  if type "$ACTION" &>/dev/null; then
    "$ACTION" "${ARGS[@]}"
  else
    error "unknown command: $SUBCOMMAND"
  fi
}

invoke_subcommand "$SUBCOMMAND" "${ARGS[@]}"